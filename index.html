<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>入場管理アプリ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196F3">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    /* リセットとベース設定 */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 12px;
      color: #333;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* コンテナ */
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 24px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
    }

    /* ヘッダー */
    .header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 3px solid #e9ecef;
    }

    .header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: #2196f3;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* ボタンベーススタイル */
    button {
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 48px;
      padding: 12px 20px;
      position: relative;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    /* ボタンアニメーション */
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* プライマリボタン */
    .btn-primary {
      background: linear-gradient(145deg, #2196f3, #1976d2);
      color: white;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.3);
      min-height: 56px;
      font-size: 1.1rem;
    }

    .btn-primary:hover {
      background: linear-gradient(145deg, #1976d2, #1565c0);
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
      transform: translateY(-2px);
    }

    /* セカンダリボタン */
    .btn-secondary {
      background: linear-gradient(145deg, #ff9800, #f57c00);
      color: white;
      box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
      min-height: 56px;
      font-size: 1.1rem;
    }

    .btn-secondary:hover {
      background: linear-gradient(145deg, #f57c00, #ef6c00);
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
      transform: translateY(-2px);
    }

    /* 成功ボタン */
    .btn-success {
      background: linear-gradient(145deg, #4caf50, #388e3c);
      color: white;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
    }

    .btn-success:hover {
      background: linear-gradient(145deg, #388e3c, #2e7d32);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      transform: translateY(-2px);
    }

    /* 警告ボタン */
    .btn-warning {
      background: linear-gradient(145deg, #ff9800, #f57c00);
      color: white;
      box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
    }

    .btn-warning:hover {
      background: linear-gradient(145deg, #f57c00, #ef6c00);
      transform: translateY(-2px);
    }

    /* 危険ボタン */
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
      color: white;
      box-shadow: 0 4px 16px rgba(244, 67, 54, 0.3);
    }

    .btn-danger:hover {
      background: linear-gradient(145deg, #d32f2f, #c62828);
      transform: translateY(-2px);
    }

    /* 小さいボタン */
    .btn-small {
      min-height: 40px;
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    /* 大きいボタン */
    .btn-large {
      min-height: 64px;
      padding: 16px 32px;
      font-size: 1.2rem;
      font-weight: 700;
    }

    /* 全幅ボタン */
    .btn-full {
      width: 100%;
      margin: 8px 0;
    }

    /* カード */
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h2,
    .card h3 {
      margin: 0 0 20px 0;
      color: #2196f3;
      text-align: center;
      font-weight: 600;
    }

    .card h2 {
      font-size: 1.4rem;
    }

    .card h3 {
      font-size: 1.2rem;
    }

    /* 統計表示 */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      text-align: center;
    }

    .stat-item {
      background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      padding: 20px 16px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }

    .stat-number {
      font-size: 2.2rem;
      font-weight: 800;
      color: #2196f3;
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.95rem;
      color: #666;
      font-weight: 600;
    }

    /* 画面管理 */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 1000;
      padding: 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .screen .container {
      min-height: calc(100vh - 24px);
      display: flex;
      flex-direction: column;
    }

    .hidden {
      display: none !important;
    }

    /* 画面ヘッダー */
    .screen-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e9ecef;
      gap: 16px;
    }

    .screen-header h2 {
      margin: 0;
      flex: 1;
      text-align: center;
      color: #2196f3;
      font-size: 1.4rem;
      font-weight: 600;
    }

    /* QRコードリーダー */
    #qrReader {
      width: 100%;
      max-width: 360px;
      margin: 0 auto 24px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    /* スキャンコントロール */
    .scan-controls {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .scan-controls > button {
      margin: 6px;
      min-width: 120px;
    }

    /* ステータス表示 */
    .scan-status {
      text-align: center;
      margin: 20px 0;
      padding: 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .scan-status.scanning {
      color: #2196f3;
      border-color: #2196f3;
      background: rgba(33, 150, 243, 0.1);
    }

    .scan-status.success {
      color: #4caf50;
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }

    .scan-status.error {
      color: #f44336;
      border-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    .scan-status.paused {
      color: #ff9800;
      border-color: #ff9800;
      background: rgba(255, 152, 0, 0.1);
    }

    /* 入力フィールド */
    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 1rem;
    }

    input[type='text'],
    input[type='number'],
    input[type='search'],
    input[type='date'] {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 1.1rem;
      background: white;
      transition: all 0.2s ease;
      min-height: 48px;
    }

    input:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .search-input {
      text-align: center;
      font-weight: 600;
    }

    /* 顧客情報表示 */
    .customer-info {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 1rem;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #555;
      min-width: 120px;
    }

    .info-value {
      font-weight: 500;
      color: #333;
      text-align: right;
      flex: 1;
    }

    /* エントリーセクション */
    .entry-section {
      background: linear-gradient(145deg, #4caf50, #45a049);
      color: white;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: 0 6px 24px rgba(76, 175, 80, 0.3);
    }

    .entry-section h3 {
      color: white;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.2rem;
    }

    .entry-section .input-group input {
      background: white;
      color: #333;
      text-align: center;
      font-weight: 700;
      font-size: 1.3rem;
    }

    .entry-section button {
      background: white;
      color: #4caf50;
      font-weight: 700;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    /* 完了画面 */
    .complete-content {
      text-align: center;
      padding: 40px 24px;
      background: linear-gradient(145deg, #4caf50, #45a049);
      color: white;
      border-radius: 20px;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(76, 175, 80, 0.4);
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .completion-details {
      margin: 20px 0;
      text-align: left;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
    }

    .completion-details p {
      margin: 12px 0;
      font-weight: 500;
    }

    /* メニューグリッド */
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 24px;
    }

    .menu-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 16px;
      padding: 20px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .menu-item:hover {
      border-color: #2196f3;
      box-shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
      transform: translateY(-2px);
    }

    .menu-item.danger {
      border-color: #f44336;
      color: #f44336;
    }

    .menu-item.danger:hover {
      border-color: #d32f2f;
      box-shadow: 0 4px 20px rgba(244, 67, 54, 0.15);
    }

    .menu-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .menu-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .menu-desc {
      font-size: 0.8rem;
      color: #666;
      line-height: 1.2;
    }

    /* リストコントロール */
    .list-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .list-stats {
      margin-bottom: 20px;
      font-weight: 600;
      color: #666;
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    /* データリスト */
    .data-list {
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .list-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .list-item:hover {
      border-color: #2196f3;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.1);
    }

    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .customer-name {
      font-weight: 600;
      font-size: 1.1rem;
      color: #333;
    }

    .entry-status {
      font-size: 0.8rem;
      padding: 4px 12px;
      border-radius: 16px;
      font-weight: 600;
    }

    .entry-status.entered {
      background: #d4edda;
      color: #155724;
    }

    .entry-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .list-item-details {
      font-size: 0.9rem;
      color: #666;
      line-height: 1.4;
    }

    /* 検索結果 */
    .search-result {
      margin-top: 20px;
    }

    .customer-result {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .customer-result:hover {
      border-color: #2196f3;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.1);
    }

    /* メッセージ */
    .no-results,
    .no-data {
      text-align: center;
      color: #666;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
    }

    /* テスト番号 */
    .test-numbers {
      margin-top: 20px;
      padding: 16px;
      background: rgba(33, 150, 243, 0.1);
      border-radius: 12px;
      font-size: 0.9rem;
      text-align: center;
      border: 1px solid rgba(33, 150, 243, 0.2);
    }

    /* ローディング */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      color: white;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* レスポンシブデザイン */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 16px 12px;
      }

      .menu-grid {
        grid-template-columns: 1fr;
      }

      .menu-item {
        min-height: 100px;
      }

      .stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .screen-header {
        flex-wrap: wrap;
        text-align: center;
      }

      .list-item-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .info-value {
        text-align: left;
      }
    }

    /* 横向き対応 */
    @media (orientation: landscape) and (max-height: 500px) {
      .complete-content {
        padding: 20px;
      }

      .success-icon {
        font-size: 3rem;
        margin-bottom: 12px;
      }

      #qrReader {
        max-width: 280px;
        margin-bottom: 16px;
      }
    }

    /* タッチデバイス最適化 */
    @media (pointer: coarse) {
      button {
        min-height: 48px;
        padding: 12px 20px;
      }

      .btn-large {
        min-height: 56px;
      }

      input {
        min-height: 48px;
        font-size: 16px; /* ズーム防止 */
      }
    }
  </style>
</head>
<body>
  <!-- メイン画面 -->
  <div class="container" id="mainScreen">
    <div class="header">
      <h1>🎫 入場管理アプリ</h1>
      <div class="header-buttons">
        <button id="updateBtn" class="btn-success btn-small">📥 データ更新</button>
        <button id="menuBtn" class="btn-success btn-small">📋 データ管理</button>
      </div>
    </div>

    <div class="card">
      <h2>QRコードをスキャン</h2>
      <button id="startQRScan" class="btn-primary btn-large btn-full">📷 QRコード読み取り</button>
      <button id="manualEntry" class="btn-secondary btn-large btn-full">📝 手動でチケット番号入力</button>
    </div>

    <div class="card">
      <h3>📊 本日の状況</h3>
      <div id="stats" class="stats">
        <div class="stat-item">
          <div class="stat-number" id="entryCount">0</div>
          <div class="stat-label">入場者数</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalTickets">0</div>
          <div class="stat-label">総チケット数</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QRスキャン画面 -->
  <div class="screen hidden" id="qrScanScreen">
    <div class="container">
      <div class="screen-header">
        <button id="stopQRScan" class="btn-danger btn-small">← 戻る</button>
        <h2>QRコード読み取り</h2>
      </div>

      <div id="qrReader"></div>
      <p id="qrScanStatus" class="scan-status">QRコードをカメラに向けてください</p>

      <div class="scan-controls">
        <button id="pauseResumeBtn" class="btn-warning">⏸️ 一時停止</button>
        <button id="continuousModeBtn" class="btn-success">🔄 連続スキャン: ON</button>
        <button id="switchToManual" class="btn-secondary btn-full">📝 手動入力に切り替え</button>
      </div>
    </div>
  </div>

  <!-- 手動入力画面 -->
  <div class="screen hidden" id="manualEntryScreen">
    <div class="container">
      <div class="screen-header">
        <button id="backToMain" class="btn-danger btn-small">← 戻る</button>
        <h2>手動検索</h2>
      </div>

      <div class="card">
        <h3>🔍 顧客検索</h3>
        <p style="text-align: center; margin-bottom: 20px; color: #666">
          チケット番号、名前、メールアドレスで検索できます
        </p>

        <div class="input-group">
          <input type="text" id="searchInput" class="search-input" placeholder="チケット番号または名前を入力">
        </div>

        <button id="searchButton" class="btn-primary btn-large btn-full">🔍 検索</button>

        <div class="test-numbers">
          <p><strong>テスト用チケット番号:</strong> 634, 183, 631</p>
        </div>
      </div>

      <div id="searchResult" class="search-result"></div>
    </div>
  </div>

  <!-- 顧客情報画面 -->
  <div class="screen hidden" id="customerInfoScreen">
    <div class="container">
      <div class="screen-header">
        <button id="backToSearch" class="btn-danger btn-small">← 戻る</button>
        <h2>👤 顧客情報</h2>
      </div>

      <div class="customer-info">
        <div class="info-item">
          <span class="info-label">チケット番号:</span>
          <span id="customerTicket" class="info-value">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">お名前:</span>
          <span id="customerName" class="info-value">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">メールアドレス:</span>
          <span id="customerEmail" class="info-value">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">購入枚数:</span>
          <span id="customerTickets" class="info-value">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">座席番号:</span>
          <span id="customerSeat" class="info-value">-</span>
        </div>
      </div>

      <div id="entryHistory" class="card hidden">
        <h3>📝 入場履歴</h3>
        <div id="entryHistoryList"></div>
      </div>

      <div class="entry-section">
        <h3>入場処理</h3>
        <div class="input-group">
          <label for="entryCountInput">入場人数:</label>
          <input type="number" id="entryCountInput" min="1" max="10" value="1">
        </div>
        <button id="confirmEntry" class="btn-full">✅ 入場を確定</button>
      </div>
    </div>
  </div>

  <!-- 完了画面 -->
  <div class="screen hidden" id="completionScreen">
    <div class="container">
      <div class="complete-content">
        <div class="success-icon">✅</div>
        <h2>入場完了</h2>
        <div class="completion-details">
          <p><strong>お名前:</strong> <span id="completedCustomerName">-</span></p>
          <p><strong>チケット番号:</strong> <span id="completedTicketNumber">-</span></p>
          <p><strong>入場人数:</strong> <span id="completedTickets">-</span></p>
          <p><strong>入場時刻:</strong> <span id="entryTime">-</span></p>
        </div>
        <button id="nextCustomer" class="btn-full">次の顧客を処理</button>
      </div>
    </div>
  </div>

  <!-- データ管理メニュー画面 -->
  <div class="screen hidden" id="dataMenuScreen">
    <div class="container">
      <div class="screen-header">
        <button id="backToMainFromMenu" class="btn-danger btn-small">← 戻る</button>
        <h2>📋 データ管理</h2>
      </div>

      <div class="menu-grid">
        <button id="viewCustomersBtn" class="menu-item">
          <div class="menu-icon">👥</div>
          <div class="menu-title">顧客データ一覧</div>
          <div class="menu-desc">全顧客データを表示</div>
        </button>
        <button id="viewEntriesBtn" class="menu-item">
          <div class="menu-icon">📋</div>
          <div class="menu-title">入場記録一覧</div>
          <div class="menu-desc">入場履歴を表示</div>
        </button>
        <button id="exportDataBtn" class="menu-item">
          <div class="menu-icon">💾</div>
          <div class="menu-title">データエクスポート</div>
          <div class="menu-desc">CSVでダウンロード</div>
        </button>
        <button id="clearDataBtn" class="menu-item danger">
          <div class="menu-icon">🗑️</div>
          <div class="menu-title">データクリア</div>
          <div class="menu-desc">入場記録をリセット</div>
        </button>
      </div>
    </div>
  </div>

  <!-- 顧客データ一覧画面 -->
  <div class="screen hidden" id="customerListScreen">
    <div class="container">
      <div class="screen-header">
        <button id="backToMenuFromCustomers" class="btn-danger btn-small">← 戻る</button>
        <h2>👥 顧客データ一覧</h2>
      </div>

      <div class="list-controls">
        <input type="search" id="customerSearchInput" class="search-input" placeholder="名前、チケット番号、メールで検索...">
        <select id="customerFilterSelect" class="filter-select">
          <option value="all">全て表示</option>
          <option value="entered">入場済み</option>
          <option value="not-entered">未入場</option>
        </select>
      </div>

      <div class="list-stats">
        <span id="customerListStats">顧客データを読み込み中...</span>
      </div>

      <div id="customerList" class="data-list"></div>
    </div>
  </div>

  <!-- 入場記録一覧画面 -->
  <div class="screen hidden" id="entryListScreen">
    <div class="container">
      <div class="screen-header">
        <button id="backToMenuFromEntries" class="btn-danger btn-small">← 戻る</button>
        <h2>📋 入場記録一覧</h2>
      </div>

      <div class="list-controls">
        <input type="search" id="entrySearchInput" class="search-input" placeholder="名前、チケット番号で検索...">
        <input type="date" id="entryDateFilter" class="date-filter">
      </div>

      <div class="list-stats">
        <span id="entryListStats">入場記録を読み込み中...</span>
      </div>

      <div id="entryList" class="data-list"></div>
    </div>
  </div>

  <!-- ローディング -->
  <div class="loading hidden" id="loading">
    <div class="spinner"></div>
    <p>処理中...</p>
  </div>

  <script>
    // 入場管理アプリのメイン設定
    const CONFIG = {
      GOOGLE_APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzhMroDqsp9_fNtxRoj9Qcl39iY2YXGQdc5HxT0AFbEppDLz2kguHQGgmxB6nig-S-W/exec',
      STORAGE_KEY: 'entryManagementData',
      CUSTOMER_STORAGE_KEY: 'customerData'
    };

    // グローバル変数
    let html5QrCode = null;
    let customerData = [];
    let entryData = [];
    let isScanning = false;
    let isPaused = false;
    let continuousScanMode = true;
    let cameraInitialized = false;
    let processedCustomers = new Set();

    // アプリ初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('入場管理アプリが読み込まれました');
      
      // 画面要素の取得
      const mainScreen = document.getElementById('mainScreen');
      const qrScanScreen = document.getElementById('qrScanScreen');
      const manualEntryScreen = document.getElementById('manualEntryScreen');
      const customerInfoScreen = document.getElementById('customerInfoScreen');
      const completionScreen = document.getElementById('completionScreen');
      const dataMenuScreen = document.getElementById('dataMenuScreen');
      const customerListScreen = document.getElementById('customerListScreen');
      const entryListScreen = document.getElementById('entryListScreen');
      const loading = document.getElementById('loading');
      
      // 初期データ読み込み
      loadStoredData();
      updateStats();
      
      // 画面切り替え関数
      function showScreen(screenId) {
        console.log('画面切り替え:', screenId);
        
        // 全ての画面を非表示
        const screens = [mainScreen, qrScanScreen, manualEntryScreen, customerInfoScreen, 
                        completionScreen, dataMenuScreen, customerListScreen, entryListScreen];
        screens.forEach(screen => {
          if (screen) screen.classList.add('hidden');
        });
        
        // 指定された画面を表示
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
          targetScreen.classList.remove('hidden');
        }
      }
      
      // ローディング表示/非表示
      function showLoading() {
        loading.classList.remove('hidden');
      }
      
      function hideLoading() {
        loading.classList.add('hidden');
      }
      
      // Google Sheets からデータを取得
      async function fetchCustomerData() {
        try {
          showLoading();
          console.log('Google Sheetsからデータを取得中...');
          
          const response = await fetch(CONFIG.GOOGLE_APPS_SCRIPT_URL + '?action=getCustomers');
          const data = await response.json();
          
          if (data.success) {
            customerData = data.customers || [];
            localStorage.setItem(CONFIG.CUSTOMER_STORAGE_KEY, JSON.stringify(customerData));
            console.log(`${customerData.length}件の顧客データを取得`);
            updateStats();
            return true;
          } else {
            throw new Error(data.error || 'データ取得に失敗しました');
          }
        } catch (error) {
          console.error('データ取得エラー:', error);
          // オフライン用のサンプルデータ
          customerData = [
            {
              ticketNumber: '634',
              name: 'テスト 太郎',
              email: 'test1@example.com',
              ticketCount: 2,
              seatNumber: 'A-12'
            },
            {
              ticketNumber: '183',
              name: 'サンプル 花子',
              email: 'test2@example.com',
              ticketCount: 1,
              seatNumber: 'B-05'
            },
            {
              ticketNumber: '631',
              name: 'デモ 次郎',
              email: 'test3@example.com',
              ticketCount: 3,
              seatNumber: 'C-08'
            }
          ];
          localStorage.setItem(CONFIG.CUSTOMER_STORAGE_KEY, JSON.stringify(customerData));
          alert('オフラインモードで動作しています\nサンプルデータを使用します');
          updateStats();
          return false;
        } finally {
          hideLoading();
        }
      }
      
      // ローカルストレージからデータ読み込み
      function loadStoredData() {
        const storedCustomers = localStorage.getItem(CONFIG.CUSTOMER_STORAGE_KEY);
        const storedEntries = localStorage.getItem(CONFIG.STORAGE_KEY);
        
        if (storedCustomers) {
          customerData = JSON.parse(storedCustomers);
        }
        
        if (storedEntries) {
          entryData = JSON.parse(storedEntries);
          // Set processed customers
          entryData.forEach(entry => {
            processedCustomers.add(entry.ticketNumber);
          });
        }
        
        console.log(`保存済みデータ読み込み: 顧客${customerData.length}件, 入場記録${entryData.length}件`);
      }
      
      // 統計情報更新
      function updateStats() {
        const entryCountElement = document.getElementById('entryCount');
        const totalTicketsElement = document.getElementById('totalTickets');
        
        const totalEntries = entryData.reduce((sum, entry) => sum + (entry.entryCount || 1), 0);
        const totalTickets = customerData.reduce((sum, customer) => sum + (customer.ticketCount || 1), 0);
        
        if (entryCountElement) entryCountElement.textContent = totalEntries;
        if (totalTicketsElement) totalTicketsElement.textContent = totalTickets;
      }
      
      // QRコード読み取り開始
      function startQRScanner() {
        console.log('QRスキャナー開始');
        
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("qrReader");
        }
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };
        
        Html5Qrcode.getCameras().then(cameras => {
          if (cameras && cameras.length) {
            const cameraId = cameras[0].id;
            
            html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure)
              .then(() => {
                console.log('QRスキャナー開始成功');
                isScanning = true;
                cameraInitialized = true;
                updateScanStatus('QRコードをカメラに向けてください', 'scanning');
              })
              .catch(err => {
                console.error('QRスキャナー開始エラー:', err);
                updateScanStatus('カメラの起動に失敗しました', 'error');
                alert('カメラへのアクセス許可が必要です。\nブラウザの設定を確認してください。');
              });
          } else {
            alert('カメラが見つかりませんでした');
          }
        }).catch(err => {
          console.error('カメラ取得エラー:', err);
          alert('カメラへのアクセスに失敗しました');
        });
      }
      
      // QRスキャン成功時の処理
      function onScanSuccess(decodedText, decodedResult) {
        console.log('QRコード読み取り成功:', decodedText);
        
        if (isPaused) return;
        
        updateScanStatus('QRコードを読み取りました', 'success');
        
        // 顧客検索
        const customer = findCustomer(decodedText);
        if (customer) {
          displayCustomerInfo(customer);
          showScreen('customerInfoScreen');
          
          if (!continuousScanMode) {
            pauseQRScanner();
          }
        } else {
          updateScanStatus('該当する顧客が見つかりませんでした', 'error');
          setTimeout(() => {
            if (isScanning && !isPaused) {
              updateScanStatus('QRコードをカメラに向けてください', 'scanning');
            }
          }, 2000);
        }
      }
      
      // QRスキャン失敗時の処理
      function onScanFailure(error) {
        // エラーメッセージは表示しない（通常の動作）
      }
      
      // スキャンステータス更新
      function updateScanStatus(message, type = '') {
        const statusElement = document.getElementById('qrScanStatus');
        if (statusElement) {
          statusElement.textContent = message;
          statusElement.className = 'scan-status ' + type;
        }
      }
      
      // QRスキャナー一時停止
      function pauseQRScanner() {
        if (html5QrCode && isScanning && !isPaused) {
          html5QrCode.pause();
          isPaused = true;
          updateScanStatus('スキャンを一時停止しました', 'paused');
          console.log('QRスキャナー一時停止');
        }
      }
      
      // QRスキャナー再開
      function resumeQRScanner() {
        if (html5QrCode && isScanning && isPaused) {
          html5QrCode.resume();
          isPaused = false;
          updateScanStatus('QRコードをカメラに向けてください', 'scanning');
          console.log('QRスキャナー再開');
        }
      }
      
      // QRスキャナー停止
      function stopQRScanner() {
        if (html5QrCode && isScanning) {
          html5QrCode.stop().then(() => {
            console.log('QRスキャナー停止');
            isScanning = false;
            isPaused = false;
            cameraInitialized = false;
          }).catch(err => {
            console.error('QRスキャナー停止エラー:', err);
          });
        }
      }
      
      // 顧客検索
      function findCustomer(query) {
        return customerData.find(customer => 
          customer.ticketNumber === query || 
          customer.name.includes(query) || 
          customer.email.includes(query)
        );
      }
      
      // 顧客情報表示
      function displayCustomerInfo(customer) {
        document.getElementById('customerTicket').textContent = customer.ticketNumber || '-';
        document.getElementById('customerName').textContent = customer.name || '-';
        document.getElementById('customerEmail').textContent = customer.email || '-';
        document.getElementById('customerTickets').textContent = customer.ticketCount || '-';
        document.getElementById('customerSeat').textContent = customer.seatNumber || '-';
        
        // 入場履歴表示
        const entryHistory = entryData.filter(entry => entry.ticketNumber === customer.ticketNumber);
        if (entryHistory.length > 0) {
          const historyElement = document.getElementById('entryHistory');
          const historyListElement = document.getElementById('entryHistoryList');
          
          historyElement.classList.remove('hidden');
          historyListElement.innerHTML = entryHistory.map(entry =>
            `<p><strong>${entry.entryTime}</strong> - ${entry.entryCount}名</p>`
          ).join('');
        }
      }
      
      // 入場記録保存
      async function saveEntry(customer, entryCount) {
        const entry = {
          ticketNumber: customer.ticketNumber,
          customerName: customer.name,
          entryCount: parseInt(entryCount),
          entryTime: new Date().toISOString(),
          timestamp: Date.now()
        };
        
        entryData.push(entry);
        processedCustomers.add(customer.ticketNumber);
        
        // ローカル保存
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(entryData));
        
        // Google Sheetsに送信
        try {
          const response = await fetch(CONFIG.GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              action: 'addEntry',
              ...entry
            })
          });
          
          const result = await response.json();
          if (result.success) {
            console.log('入場記録をGoogle Sheetsに保存しました');
          }
        } catch (error) {
          console.error('Google Sheets保存エラー:', error);
        }
        
        updateStats();
        return entry;
      }
      
      // イベントリスナー設定
      setupEventListeners();
      
      function setupEventListeners() {
        // メイン画面のボタン
        const startQRScanBtn = document.getElementById('startQRScan');
        if (startQRScanBtn) {
          startQRScanBtn.addEventListener('click', function() {
            console.log('QRスキャン開始');
            showScreen('qrScanScreen');
            startQRScanner();
          });
        }
        
        const manualEntryBtn = document.getElementById('manualEntry');
        if (manualEntryBtn) {
          manualEntryBtn.addEventListener('click', function() {
            showScreen('manualEntryScreen');
          });
        }
        
        const updateBtn = document.getElementById('updateBtn');
        if (updateBtn) {
          updateBtn.addEventListener('click', async function() {
            await fetchCustomerData();
            alert('データを更新しました');
          });
        }
        
        const menuBtn = document.getElementById('menuBtn');
        if (menuBtn) {
          menuBtn.addEventListener('click', function() {
            showScreen('dataMenuScreen');
          });
        }
        
        // QRスキャン画面のボタン
        const stopQRScanBtn = document.getElementById('stopQRScan');
        if (stopQRScanBtn) {
          stopQRScanBtn.addEventListener('click', function() {
            stopQRScanner();
            showScreen('mainScreen');
          });
        }
        
        const pauseResumeBtn = document.getElementById('pauseResumeBtn');
        if (pauseResumeBtn) {
          pauseResumeBtn.addEventListener('click', function() {
            if (isPaused) {
              resumeQRScanner();
              pauseResumeBtn.innerHTML = '⏸️ 一時停止';
            } else {
              pauseQRScanner();
              pauseResumeBtn.innerHTML = '▶️ 再開';
            }
          });
        }
        
        const continuousModeBtn = document.getElementById('continuousModeBtn');
        if (continuousModeBtn) {
          continuousModeBtn.addEventListener('click', function() {
            continuousScanMode = !continuousScanMode;
            if (continuousScanMode) {
              continuousModeBtn.innerHTML = '🔄 連続スキャン: ON';
            } else {
              continuousModeBtn.innerHTML = '🔄 連続スキャン: OFF';
            }
          });
        }
        
        const switchToManualBtn = document.getElementById('switchToManual');
        if (switchToManualBtn) {
          switchToManualBtn.addEventListener('click', function() {
            stopQRScanner();
            showScreen('manualEntryScreen');
          });
        }
        
        // 手動入力画面のボタン
        const backToMainBtn = document.getElementById('backToMain');
        if (backToMainBtn) {
          backToMainBtn.addEventListener('click', function() {
            showScreen('mainScreen');
          });
        }
        
        const searchButton = document.getElementById('searchButton');
        if (searchButton) {
          searchButton.addEventListener('click', function() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput ? searchInput.value.trim() : '';
            
            if (!query) {
              alert('検索キーワードを入力してください');
              return;
            }
            
            const customer = findCustomer(query);
            if (customer) {
              displayCustomerInfo(customer);
              showScreen('customerInfoScreen');
            } else {
              alert('該当する顧客が見つかりませんでした');
            }
          });
        }
        
        // 顧客情報画面のボタン
        const backToSearchBtn = document.getElementById('backToSearch');
        if (backToSearchBtn) {
          backToSearchBtn.addEventListener('click', function() {
            showScreen('manualEntryScreen');
          });
        }
        
        const confirmEntryBtn = document.getElementById('confirmEntry');
        if (confirmEntryBtn) {
          confirmEntryBtn.addEventListener('click', async function() {
            const entryCount = parseInt(document.getElementById('entryCountInput').value);
            const customerTicket = document.getElementById('customerTicket').textContent;
            const customerName = document.getElementById('customerName').textContent;
            
            if (!customerTicket || customerTicket === '-') {
              alert('顧客情報が取得できませんでした');
              return;
            }
            
            const customer = {
              ticketNumber: customerTicket,
              name: customerName
            };
            
            try {
              showLoading();
              const entry = await saveEntry(customer, entryCount);
              
              // 完了画面に遷移
              document.getElementById('completedCustomerName').textContent = customerName;
              document.getElementById('completedTicketNumber').textContent = customerTicket;
              document.getElementById('completedTickets').textContent = entryCount;
              document.getElementById('entryTime').textContent = new Date().toLocaleString('ja-JP');
              
              showScreen('completionScreen');
            } catch (error) {
              console.error('入場処理エラー:', error);
              alert('入場処理中にエラーが発生しました');
            } finally {
              hideLoading();
            }
          });
        }
        
        // 完了画面のボタン
        const nextCustomerBtn = document.getElementById('nextCustomer');
        if (nextCustomerBtn) {
          nextCustomerBtn.addEventListener('click', function() {
            if (continuousScanMode && cameraInitialized) {
              showScreen('qrScanScreen');
              resumeQRScanner();
            } else {
              showScreen('mainScreen');
            }
          });
        }
        
        // データ管理メニューのボタン
        const backToMainFromMenuBtn = document.getElementById('backToMainFromMenu');
        if (backToMainFromMenuBtn) {
          backToMainFromMenuBtn.addEventListener('click', function() {
            showScreen('mainScreen');
          });
        }
        
        const viewCustomersBtn = document.getElementById('viewCustomersBtn');
        if (viewCustomersBtn) {
          viewCustomersBtn.addEventListener('click', function() {
            displayCustomerList();
            showScreen('customerListScreen');
          });
        }
        
        const viewEntriesBtn = document.getElementById('viewEntriesBtn');
        if (viewEntriesBtn) {
          viewEntriesBtn.addEventListener('click', function() {
            displayEntryList();
            showScreen('entryListScreen');
          });
        }
        
        const exportDataBtn = document.getElementById('exportDataBtn');
        if (exportDataBtn) {
          exportDataBtn.addEventListener('click', function() {
            exportToCSV();
          });
        }
        
        const clearDataBtn = document.getElementById('clearDataBtn');
        if (clearDataBtn) {
          clearDataBtn.addEventListener('click', function() {
            if (confirm('入場記録を全て削除しますか？この操作は取り消せません。')) {
              entryData = [];
              processedCustomers.clear();
              localStorage.removeItem(CONFIG.STORAGE_KEY);
              updateStats();
              alert('入場記録をクリアしました');
            }
          });
        }
        
        // 顧客一覧画面のボタン
        const backToMenuFromCustomersBtn = document.getElementById('backToMenuFromCustomers');
        if (backToMenuFromCustomersBtn) {
          backToMenuFromCustomersBtn.addEventListener('click', function() {
            showScreen('dataMenuScreen');
          });
        }
        
        // 入場記録一覧画面のボタン
        const backToMenuFromEntriesBtn = document.getElementById('backToMenuFromEntries');
        if (backToMenuFromEntriesBtn) {
          backToMenuFromEntriesBtn.addEventListener('click', function() {
            showScreen('dataMenuScreen');
          });
        }
        
        // ボタンにクリック時の視覚的フィードバックを追加
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach((button) => {
          button.addEventListener('click', function() {
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
              button.style.transform = '';
            }, 150);
          });
        });
      }
      
      // 顧客一覧表示
      function displayCustomerList() {
        const customerList = document.getElementById('customerList');
        const customerListStats = document.getElementById('customerListStats');
        
        if (!customerList || !customerListStats) return;
        
        const enteredCount = customerData.filter(customer => 
          processedCustomers.has(customer.ticketNumber)
        ).length;
        
        customerListStats.textContent = `全${customerData.length}件中 ${enteredCount}件入場済み`;
        
        if (customerData.length === 0) {
          customerList.innerHTML = '<div class="no-data">顧客データがありません</div>';
          return;
        }
        
        customerList.innerHTML = customerData.map(customer => {
          const isEntered = processedCustomers.has(customer.ticketNumber);
          return `
            <div class="list-item">
              <div class="list-item-header">
                <span class="customer-name">${customer.name}</span>
                <span class="entry-status ${isEntered ? 'entered' : 'pending'}">
                  ${isEntered ? '入場済み' : '未入場'}
                </span>
              </div>
              <div class="list-item-details">
                チケット番号: ${customer.ticketNumber}<br>
                メール: ${customer.email}<br>
                購入枚数: ${customer.ticketCount}枚 | 座席: ${customer.seatNumber}
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 入場記録一覧表示
      function displayEntryList() {
        const entryList = document.getElementById('entryList');
        const entryListStats = document.getElementById('entryListStats');
        
        if (!entryList || !entryListStats) return;
        
        const totalEntries = entryData.reduce((sum, entry) => sum + (entry.entryCount || 1), 0);
        entryListStats.textContent = `全${entryData.length}件の記録 (入場者数: ${totalEntries}名)`;
        
        if (entryData.length === 0) {
          entryList.innerHTML = '<div class="no-data">入場記録がありません</div>';
          return;
        }
        
        const sortedEntries = [...entryData].reverse(); // 最新順
        
        entryList.innerHTML = sortedEntries.map(entry => `
          <div class="list-item">
            <div class="list-item-header">
              <span class="customer-name">${entry.customerName}</span>
              <span class="entry-status entered">${entry.entryCount}名</span>
            </div>
            <div class="list-item-details">
              チケット番号: ${entry.ticketNumber}<br>
              入場時刻: ${new Date(entry.entryTime).toLocaleString('ja-JP')}
            </div>
          </div>
        `).join('');
      }
      
      // CSV エクスポート
      function exportToCSV() {
        if (entryData.length === 0) {
          alert('エクスポートする入場記録がありません');
          return;
        }
        
        const headers = ['チケット番号', '顧客名', '入場人数', '入場時刻'];
        const csvContent = [
          headers.join(','),
          ...entryData.map(entry => [
            entry.ticketNumber,
            entry.customerName,
            entry.entryCount,
            new Date(entry.entryTime).toLocaleString('ja-JP')
          ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `入場記録_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('CSVファイルをダウンロードしました');
      }
      
      // 初期化完了
      console.log('入場管理アプリの初期化が完了しました');
      
      // 初回データ読み込み
      if (customerData.length === 0) {
        fetchCustomerData();
      }
    });
  </script>
</body>
</html>
